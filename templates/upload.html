{# filepath: /Users/suya/Desktop/Baduanjin/templates/upload.html #}
{% extends "base.html" %}

{% block title %}Upload Analysis - ChiWell{% endblock %}

{% block content %}
<div class="page-container upload-container">
    <h1>Upload Video for Action Analysis</h1>
    <p class="description">
        Upload a video of your Baduanjin practice. The system will provide a comprehensive analysis and traditional Chinese medicine-based wellness advice based on your movements.
    </p>

    <div class="upload-form">
        <label for="videoUpload" class="file-label">Select Action Video File</label>
        <input type="file" id="videoUpload" accept="video/*" class="file-input">
        <button id="actionUploadBtn" class="button button-primary">Upload & Analyze Action</button>
    </div>

    {# ç”¨äºæ˜¾ç¤ºä¸Šä¼ çŠ¶æ€å’Œé”™è¯¯ #}
    <div id="actionUploadStatus" class="upload-status" style="margin-top: 20px;"></div>

    {# è¿™æ˜¯ç”¨æ¥æ˜¾ç¤º Gemini åˆ†ææŠ¥å‘Šçš„å®¹å™¨ #}
    <div id="resultText" class="prediction-result"
         style="margin-top: 20px; text-align: left; font-size: 1.1em; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #fdfdfd; white-space: pre-wrap;">
        </div>
</div>
{% endblock %}


{% block body_scripts %}
<script type = "text/javascript">
document.addEventListener('DOMContentLoaded', () => {
    // --- è·å–é¡µé¢ä¸Šçš„ HTML å…ƒç´  ---
    const videoUploadInput = document.getElementById('videoUpload');
    const actionUploadBtn = document.getElementById('actionUploadBtn');
    const actionUploadStatusElement = document.getElementById('actionUploadStatus');
    const fileLabel = document.querySelector('.upload-form .file-label');
    const resultTextDiv = document.getElementById('resultText');

    // æ£€æŸ¥æ ¸å¿ƒ UI å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢è„šæœ¬å´©æºƒ
    if (!videoUploadInput || !actionUploadBtn || !actionUploadStatusElement || !fileLabel || !resultTextDiv) {
        console.error("SCRIPT ERROR (Upload Page): One or more required UI elements are missing!");
        if(actionUploadStatusElement) actionUploadStatusElement.textContent = "Page Error: UI elements missing. Check HTML IDs.";
        return; // ç»ˆæ­¢è„šæœ¬ï¼Œå› ä¸ºæ²¡æœ‰å¯æ“ä½œçš„å…ƒç´ 
    }

    // --- é¡µé¢åˆå§‹åŒ–çŠ¶æ€ ---
    actionUploadBtn.disabled = true;
    resultTextDiv.style.display = 'none';

    // --- ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶ ---
    videoUploadInput.addEventListener('change', () => {
        if (videoUploadInput.files.length > 0) {
            fileLabel.textContent = videoUploadInput.files[0].name;
            actionUploadBtn.disabled = false;
            actionUploadStatusElement.textContent = '';
            resultTextDiv.style.display = 'none';
        } else {
            fileLabel.textContent = "Select Action Video File";
            actionUploadBtn.disabled = true;
        }
    });

    // --- å®šä¹‰ä¸Šä¼ å’Œåˆ†æè§†é¢‘çš„å¼‚æ­¥å‡½æ•° ---
    async function uploadActionVideo() {
        console.log("SCRIPT (Action Upload): uploadActionVideo called.");
        const file = videoUploadInput.files[0];
        if (!file) {
            actionUploadStatusElement.textContent = "Please select a video file first.";
            actionUploadStatusElement.style.color = 'red';
            return;
        }

        // --- æ›´æ–°UIï¼Œå‘ŠçŸ¥ç”¨æˆ·æ­£åœ¨å¤„ç† ---
        actionUploadStatusElement.textContent = "Uploading and analyzing, this may take a moment... ğŸ¤–";
        actionUploadStatusElement.style.color = 'var(--primary-color)';
        actionUploadBtn.disabled = true;
        fileLabel.style.opacity = '0.6';
        resultTextDiv.style.display = 'none';

        const formData = new FormData();
        formData.append('video', file);

        try {
            // --- å‘é€è¯·æ±‚åˆ°åç«¯ /predict_action ---
            const response = await fetch('/predict_action', { method: 'POST', body: formData });
            const result = await response.json();

            if (response.ok) {
                // --- è¯·æ±‚æˆåŠŸå¤„ç† ---
                actionUploadStatusElement.textContent = `Analysis Complete! ${result.message || 'Success.'}`;
                actionUploadStatusElement.style.color = 'green';
                resultTextDiv.textContent = result.report; // ä½¿ç”¨ textContent å¯ä»¥å®‰å…¨åœ°æ˜¾ç¤ºæ–‡æœ¬å¹¶ä¿ç•™æ¢è¡Œ
                resultTextDiv.style.display = 'block';

            } else {
                // --- è¯·æ±‚å¤±è´¥å¤„ç† ---
                actionUploadStatusElement.textContent = `Error: ${result.error || `Server error (${response.status})`}`;
                actionUploadStatusElement.style.color = 'red';
            }
        } catch (error) {
            // --- ç½‘ç»œæˆ–è§£æé”™è¯¯å¤„ç† ---
            console.error("SCRIPT ERROR (Action Upload): Fetch error or JSON parsing error:", error);
            actionUploadStatusElement.textContent = "An error occurred during upload or analysis. Please check the browser console.";
            actionUploadStatusElement.style.color = 'red';
        } finally {
            // --- æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œæœ€åéƒ½æ¢å¤UIçŠ¶æ€ ---
            actionUploadBtn.disabled = false;
            fileLabel.style.opacity = '1';
            console.log("SCRIPT (Action Upload): Action video processing finished.");
        }
    }

    // --- ä¸ºä¸Šä¼ æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ ---
    actionUploadBtn.addEventListener('click', uploadActionVideo);
});
</script>
{% endblock %}